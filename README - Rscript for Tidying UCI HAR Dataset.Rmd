---
title: "README - Rscript for Tidying UCI HAR Dataset"
author: "RoboRicky"
date: "8/14/2019"
output: html_document
---
# Summary of Script

The Rscript for Tidying UCI HAR Dataset performs the following 5-step procedure on the University of California-Irvine Human Activity Recognition (UCI HAR) dataset:

1. Merges the training and the test sets to create one data set.
2. Extracts only the measurements on the mean and standard deviation for each measurement.
3. Uses descriptive activity names to name the activities in the data set.
4. Appropriately labels the data set with descriptive variable names.
5. From the data set in step 4, creates a second, independent tidy data set with the average of each variable for each activity and each subject and write it to a file. 


# Instructions for Use

Download this zip archive: [UC Irvine Human Activity Recognition Dataset](https://d396qusza40orc.cloudfront.net/getdata%2Fprojectfiles%2FUCI%20HAR%20Dataset.zip) (using the embedded link will ensure you get the correct version). Unzip it to your desired workspace, preferably the same folder containing the run_analysis.R script. Make sure that the unzipped folder in your workspace is called "UCI HAR dataset" and contains 2 folders("test" and "train") and four text files ("activity_labels", "features", "features_info", and "README").

Make sure you R workspace is set to the folder containing your UCI HAR Dataset folder (not inside the UCI HAR folder), then simply source the script and a file named "UCI_HAR_Average_Mean_and_Std_Values_for_Subject-Activity_Pairs.txt" should be produced, which is a space-delimited table of the average of mean and standard deviation measurement values for each subject-activity pair. If the script is also in the folder containing the UCI HAR Dataset folder, the source command is simply this:

```{r eval=FALSE}
source(run_analysis.R). 
```

If running on Mac or Linux/other, be aware that this script was developed for Windows and uses double-backslash instead of single backslash. If the script doesn't work for you initially, open the script in a text editor and use the find-replace tool to change "\\\\" to "\\". Remember to save this change. 

As an extra feature, the script includes "save points" to write intermediate tables to a .csv file - one after step 1 and one after step 4. This way you can save the full imported & combined dataset (step 1) and/or the finished mean and std data table with all the proper labels (step 4) for later use. By default these are commented out (preceded by "#" to render them as inert text), so to create these files you need to open the script in a text editor and uncomment them by removing the preceding "##". Remember to save this change.
```{r eval=FALSE}
## write.csv(totaldata, "UCI_HAR_test_&_train_data_combined.csv")
...
## write.csv(mydata, "UCI_HAR_mean_meanFreq_and_std_values.csv")
```


# Detailed Explanation of Script

## Objectives
The objectives for this assignment were to take data from the [UC Irvine Human Activity Recognition Dataset](https://d396qusza40orc.cloudfront.net/getdata%2Fprojectfiles%2FUCI%20HAR%20Dataset.zip) and create one R script called run_analysis.R that does the following:
1. Merges the training and the test sets to create one data set.
2. Extracts only the measurements on the mean and standard deviation for each measurement.
3. Uses descriptive activity names to name the activities in the data set.
4. Appropriately labels the data set with descriptive variable names.
5. From the data set in step 4, creates a new independent tidy data set with the average of each variable for each activity and each subject.  

## Step 1 - Load and Merge Data
The script writes the test and train data to tables using read.table() on the y_test (activity number labels), subject_test (subject number labels), and x_test (data) files for each of the test and train set and binding them together with cbind(), then binds the two sets together with rbind(). 
```{r eval=FALSE}
totaldata<-rbind(cbind(read.table("UCI HAR Dataset\\test\\y_test.txt"),
                       read.table("UCI HAR Dataset\\test\\subject_test.txt"),
                       read.table("UCI HAR Dataset\\test\\X_test.txt")), 
                 cbind(read.table("UCI HAR Dataset\\train\\y_train.txt"),
                      read.table("UCI HAR Dataset\\train\\subject_train.txt"),
                      read.table("UCI HAR Dataset\\train\\X_train.txt"))
)
```

At this step, we also read in the features file to obtain the ordered list of column names for our data. Note that we don't want the row numbers (the feature names are column 2), and we don't want it in column format (so we transpose). We then add the activity and subject number column names to the front of the feature list (since they have been bound as columns 1 and 2), and then set the column names to be the same as the features list.
```{r eval=FALSE}
features<-t(read.table("UCI HAR Dataset\\features.txt", 
                       stringsAsFactors = FALSE)[,2])

features<- c("activity_number", "subject_number", features)

colnames(totaldata)<- features
```

## Step 2 - Extract mean and standard devation measurement
Reviewing the features_info codebook included with the UCI HAR dataset, feature names that contain mean() are the mean value of a measurement, and feature names that contain meanFreq() are the mean value of the frequency component of a measurement, which both qualify as mean values. Feature names that contain std() are standard deviation values. The final set of variables to consider are the angle() measurements, which use mean values, but are excluded from this set because they are simply a calculation of the angle between the the Body and Gravity mean measurements when constructed as an X-Y-Z vector, and are not sensor measurements (or means) in and of themselves. They are also easily recalculated from the included data, if we decide we need them later.

Having determined what we are looking for, next is to find the index of our desired columns using the grep() function to find any columns with "mean()", "meanFreq()", or "std()" in the name. It's important when building our regular expression to remember the escape the "(" and ")" characters so that they will be searched literally. We make sure that our key columns, activity number and subject number, are also included by concatenating them with the results of the grep() function. And once we've built this list of which column numbers we want, we use it to pull them out from totaldata into a new dataframe called mydata.
```{r eval=FALSE}
colselect<-c(1, 2, grep("mean\\(\\)|meanFreq\\(\\)|std\\(\\)", colnames(totaldata)))

mydata<- totaldata[,colselect]
```

## Step 3 - Descriptive Activity Labels

To add descriptive activity labels to our dataframe, we get first get the activity labels key from the dataset, which connects the activity number label to a description. Since the activities are listed in order, we can just take the descriptions column and let the index signify the number label. We also transpose the column so that we can used 1-dimensional notation for the index ([x] rather than [1,x]). For the sake of aesthetics and searchability, I convert the labels to lowercase and change the "walking" label to "walking_flat" so that it can be text-searched seperately from "walking_upstairs" and "walking_downstairs" while also still being able to select all three with a search for just "walking".

```{r eval=FALSE}
activity_labels<- t(read.table("UCI HAR Dataset\\activity_labels.txt", stringsAsFactors = FALSE)[,2])

activity_labels<-tolower(activity_labels)

activity_labels[1]<-"walking_flat"
```

Now that we have a key array, it's simple to create a column of descriptive activity labels by using sapply() on the activity number labels column, which we then bind to the front of the existing mydata dataframe. 
```{r eval=FALSE}
activity_column<- sapply(mydata$activity_number, function(x){activity_labels[x]})

mydata<-cbind("activity_name"=activity_column, mydata)
```

## Step 4 - Descriptive Column Names

We partially achieved this objective in step one, when we assigned the variable names list to the column names, but the variable names all follow a formula of abbreviations that could be made a little clearer. Also one label has a typo that should be fixed. First we get the list of the column names from mydata. Having looked at the column names in the optional exported table of mydata earlier, and cross-referenced with the code book, we can create a list of abbreviations, typos, and extraneous characters and then a corresponding list of replacements. Using a nested loop to iterate through the column names and the lists of abbreviations and replacements, we can use sub() to change the names. Then we set the new list of names as the column names for mydata.

```{r eval=FALSE}
columns<-colnames(mydata)

patterns<-c("^t", "^f", "BodyBody", "Acc", "Gyro", "Mag", "std", "meanFreq", "\\(\\)")

replacements<-c("time", "frequency","Body", "Accelerometer", "Gyroscope", "Magnitude", "standardDeviation", "meanFrequency", "")

for(i in 1:82){
        for(j in 1:9){
                columns[i]<-sub(patterns[j], replacements[j], columns[i], fixed=FALSE)
        }
}

colnames(mydata)<-columns
```

## Step 5: Create an Independent Tidy Data Set

The last objective is to create a tidy dataset with the average value for each subject-activity pair. We know that there are 30 subjects who each performed 6 activities, so we should have 180 rows of averaged values. We use aggregate() to calculate average of the measurement values with subject and activity as key values. I also use this opportunity to drop the activity number label column, since it is no longer useful. We then write the final table to a new text file, which I've named "UCI HAR Average Mean and Std Values for Subject-Activity Pairs."

```{r eval=FALSE}
tidyavgs<-aggregate(mydata[4:82], by=list(subject = mydata$subject_number, 
                                         activity = mydata$activity_name), mean)

write.table(tidyavgs,"UCI_HAR_Average_Mean_and_Std_Values_for_Subject-Activity_Pairs.txt", row.names=FALSE)
```

And with that, the script has completed it's task.